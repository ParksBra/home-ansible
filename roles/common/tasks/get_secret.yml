- name: debug request
  debug:
    var:
      - secret_name
      - secret_path | default('/')
      - secret_type | default('shared')
      - view_secret_value | default('true') | bool
      - expand_secret_references | default('false') | bool 
      - include_imports | default('false') | bool
      - infiscal_api_url
      - infiscal_api_key
      - infiscal_workspace_id
      - infiscal_environment
    when: debug

- name: Retrieve secret from Infiscal
  register: raw_secret_response
  no_log: "{{ not debug }}"
  uri:
    method: GET
    url: "{{ infiscal_api_url }}/secrets/{{ secret_name }}"
    headers:
      Authorization: "Bearer {{ infiscal_api_key }}"
    body_format: json
    body:
      secretPath: "{{ secret_path | default('/') }}"
      type: "{{ secret_type | default('shared') }}"
      viewSecretValue: "{{ view_secret_value | default('true') | bool }}"
      expandSecretReferences: "{{ expand_secret_references | default('false') | bool }}"
      include_imports: "{{ include_imports | default('false') | bool }}"
      workspaceId: "{{ infiscal_workspace_id }}"
      environment: "{{ infiscal_environment }}"

- name: Set fact for secret value
  set_fact:
    secret_value: "{{ raw_secret_response.json.secretValue }}"
    cacheable: true
  when: raw_secret_response.status == 200
  no_log: "{{ not lookup('env', 'DEBUG') | default(false) | bool }}"